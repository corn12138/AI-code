# 华为云 ECS （Ubuntu 22.04 / 20.04）部署 PostgreSQL 16 完整操作手册

> 适用对象：个人 / 小团队开发  > 更新时间：2025‑05‑16

---

## 目录

1. 环境与前置条件
2. Step 0 安装软件包
3. Step 1 验证服务状态
4. Step 2 创建业务账号、数据库与 Schema
5. 远程访问方案总览

   * 方案 A 公网访问（开放 5432）
   * 方案 B SSH 隧道（**推荐**）
6. 方案 A 实施步骤（监听地址 + SCRAM + SSL + 安全组）
7. 方案 B 实施步骤（Termius 端口转发）
8. 客户端连接指南

   * psql 命令行
   * DataGrip GUI
   * NestJS (TypeORM)
   * Python (psycopg2 / asyncpg)
9. 日常运维 & 附录

   * 权限调整
   * 备份、监控、升级
   * 故障排查速查表

---

## 1 环境与前置条件

| 项          | 值                                         |
| ---------- | ----------------------------------------- |
| 操作系统       | Ubuntu 20.04 / 22.04（具有 sudo 权限）          |
| PostgreSQL | 社区版 16.x （apt 默认集群 16/main）               |
| 云端端口       | 仅 22 (SSH) 对外；**未**放行 5432                |
| 本地工具       | Termius (Port Forward) + Homebrew libpq 等 |

---

## 2 Step 0 安装软件包（服务器）

```bash
sudo apt update
sudo apt install -y postgresql postgresql-contrib
```

> 完成后服务会自动启动，`systemctl status postgresql` 显示 `active (exited)` 属正常。

---

## 3 Step 1 验证服务状态

```bash
sudo systemctl status postgresql@16-main --no-pager    # 或 pg_lsclusters 查看 online 状态
```

---

## 4 Step 2 创建业务账号、数据库、schema

```bash
sudo -i -u postgres          # 切到 postgres 用户
psql                          # 进入 CLI

-- 账号
CREATE ROLE app_user WITH LOGIN PASSWORD 'Your_Str0ng_P@ss'
  NOSUPERUSER NOCREATEDB NOCREATEROLE NOREPLICATION;

-- 数据库
CREATE DATABASE app_db OWNER app_user
  ENCODING 'UTF8' LC_COLLATE 'en_US.UTF-8' LC_CTYPE 'en_US.UTF-8' TEMPLATE template0;

-- schema + 测试表
\c app_db
CREATE SCHEMA IF NOT EXISTS app_schema AUTHORIZATION app_user;
CREATE TABLE app_schema.users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 权限
GRANT USAGE ON SCHEMA app_schema TO app_user;
GRANT SELECT,INSERT,UPDATE,DELETE ON ALL TABLES IN SCHEMA app_schema TO app_user;

-- 可选：默认 search_path
ALTER ROLE app_user SET search_path = app_schema,public;
\q
exit    # 退出 postgres 用户
```

---

## 5 远程访问方案总览

| 方案    | 描述                                               | 安全性              | 每次操作          |
| ----- | ------------------------------------------------ | ---------------- | ------------- |
| **A** | 开放 5432 到指定网段；服务器监听 0.0.0.0；客户端直连                | ✅（加 SSL + SCRAM） | 无额外步骤         |
| **B** | **SSH 隧道，本机 localhost:6543 转 云端 127.0.0.1:5432** | ⭐⭐⭐⭐ 最高          | 启动 Termius 隧道 |

> **推荐** 方案 B 开发测试使用；方案 A 适合需要第三方系统直连的场景。

---

## 6 方案 A 实施步骤（公网直连）

### 6‑1 监听所有地址

```bash
sudo sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/'" \
  /etc/postgresql/16/main/postgresql.conf
```

### 6‑2 启用 SCRAM‑SHA‑256

```bash
sudo sed -i "s/^#password_encryption =.*/password_encryption = 'scram-sha-256'/" \
  /etc/postgresql/16/main/postgresql.conf
```

### 6‑3 编辑 pg\_hba.conf

```bash
sudo tee /etc/postgresql/16/main/pg_hba.conf <<'EOF'
local   all       all                          peer
hostssl app_db    app_user    1.2.3.0/24       scram-sha-256
EOF
```

> 将 `1.2.3.0/24` 替换为可信网段；临时可 `0.0.0.0/0` 但必须后续收紧。

### 6‑4 生成自签 SSL

```bash
sudo mkdir -p /etc/postgresql/ssl && cd /etc/postgresql/ssl
sudo openssl req -new -x509 -days 365 -nodes -text \
  -keyout server.key -out server.crt \
  -subj "/CN=$(hostname -I | awk '{print $1}')"
sudo chmod 600 server.key && sudo chown postgres:postgres server.*

sudo tee -a /etc/postgresql/16/main/postgresql.conf <<'EOF'
ssl = on
ssl_cert_file = '/etc/postgresql/ssl/server.crt'
ssl_key_file  = '/etc/postgresql/ssl/server.key'
EOF
```

### 6‑5 重启服务

```bash
sudo systemctl restart postgresql@16-main
```

### 6‑6 开放安全组 TCP 5432

华为云控制台 → **安全组** → “入方向” → 新增规则:

* 协议 TCP
* 端口 5432
* 源 1.2.3.0/24

---

## 7 方案 B 实施步骤（SSH 隧道，推荐）

### 7‑1 保持服务器只监听本地

确认 `listen_addresses = 'localhost'`（默认即如此），无需开放 5432 安全组。

### 7‑2 Termius 配置 Local Forward

| 字段                          | 值                    |
| --------------------------- | -------------------- |
| **Type**                    | Local                |
| **Label**                   | PG‑Tunnel            |
| **Local host / port**       | `localhost` / `6543` |
| **Destination host / port** | `127.0.0.1` / `5432` |

连接主机后，隧道自动生效，状态 Active。

### 7‑3 客户端统一连接 `localhost:6543`

* **psql**

  ```bash
  psql "host=localhost port=6543 dbname=app_db user=app_user password=Your_Str0ng_P@ss sslmode=disable"
  ```
* **DataGrip** → Host `localhost` Port `6543`
* **NestJS / TypeORM**

  ```ts
  host: 'localhost', port: 6543, ssl: false
  ```
* **Python / psycopg2** 同理。

> 隧道关闭即断开连接，安全无暴露。

---

## 8 客户端连接指南

### 8‑1 安装 psql (libpq)

```bash
brew install libpq
# 加 PATH
echo 'export PATH="/opt/homebrew/opt/libpq/bin:$PATH"' >> ~/.zprofile && source ~/.zprofile
```

### 8‑2 DataGrip

1. 新建 Data Source → PostgreSQL。
2. Host `localhost` Port `6543` (或 5432 若用方案 A)。
3. SSL Mode `require`（自签勾选 *Trust Server Certificate*）。

### 8‑3 NestJS

```ts
TypeOrmModule.forRoot({
  type: 'postgres',
  host: 'localhost',
  port: 6543,
  username: 'app_user',
  password: 'Your_Str0ng_P@ss',
  database: 'app_db',
  ssl: false,
});
```

### 8‑4 Python

```python
import psycopg2
conn = psycopg2.connect(host="localhost", port=6543, dbname="app_db",
                        user="app_user", password="Your_Str0ng_P@ss", sslmode="disable")
```

---

## 9 日常运维 & 附录

### 9‑1 权限调整

> PostgreSQL 的权限体系包含两大层面：**角色属性**（如 `SUPERUSER`、`CREATEDB`）与 **对象级 GRANT/REVOKE**。下面示例演示常见权限变更场景，并重点说明 *如何将 `app_user` 提升为超级用户（root 级）以及如何安全降权*。

| 场景            | 操作 SQL                                                       | 说明                                          |
| ------------- | ------------------------------------------------------------ | ------------------------------------------- |
| 查看当前角色属性      | `\du app_user;`                                              | 列出 `Superuser` `Create role` `Create DB` 等列 |
| **临时提权为超级用户** | `ALTER ROLE app_user WITH SUPERUSER;`                        | 慎用！超级用户可绕过所有安全策略，拥有系统级控制权                   |
| 撤销超级用户        | `ALTER ROLE app_user WITH NOSUPERUSER;`                      | 完成受控操作后务必及时降权                               |
| 授/撤建库权限       | `ALTER ROLE app_user WITH CREATEDB;` / `... NOCREATEDB;`     | 允许/禁止自己创建数据库                                |
| 授/撤建角色权限      | `ALTER ROLE app_user WITH CREATEROLE;` / `... NOCREATEROLE;` | 管理其他角色，一般只给 DBA                             |
| 授对象级权限        | `GRANT SELECT, UPDATE ON app_schema.users TO app_user;`      | 列级：`GRANT UPDATE(name) ...`                 |
| 撤对象级权限        | `REVOKE INSERT ON app_schema.users FROM app_user;`           | 可加 `CASCADE` 递归撤销                           |

#### 推荐的临时提权流程

1. **预置 SRE 超级账号**

   ```sql
   CREATE ROLE ops_admin WITH LOGIN PASSWORD 'Ops_Str0ng_P@ss' SUPERUSER;
   ```
2. **需要高权限操作时**：DBA 登录 `ops_admin` 执行 `CREATE EXTENSION`、修改系统表等。
3. **完成后**：退出 `ops_admin`，保持 `app_user` 为最小权限，降低误操作风险。

#### 行为审计 & 合规

* 建议在 `postgresql.conf` 打开：

  ```
  log_statement = 'ddl'
  log_role = on
  ```
* 将每次 `ALTER ROLE ... SUPERUSER` 操作纳入工单审批，留存审计日志。

\---### 9‑2 备份

```bash
sudo mkdir -p /var/backups/pg
sudo crontab -e
# 每晚 2:00 dump，保留 14 天
0 2 * * * pg_dump -Fc app_db > /var/backups/pg/app_db_$(date +\%F).dump && \
              find /var/backups/pg -type f -mtime +14 -delete
```

### 9‑3 监控

* `apt install prometheus-postgres-exporter`
* Grafana 导入 Dashboard ID 9628。

### 9‑4 常见故障速查

| 症状                     | 解决思路                                       |
| ---------------------- | ------------------------------------------ |
| Connection refused     | 隧道未开 / 端口被占用 / 服务未重启                       |
| no pg\_hba.conf entry  | 客户端 IP 未匹配；重启后生效                           |
| password auth failed   | 密码错误或 SCRAM 与客户端驱动不匹配                      |
| self‑signed cert error | 客户端加 SSL 并信任证书或 `rejectUnauthorized:false` |

---

> **至此，你已拥有：**
> • 生产‑就绪的账号、库、Schema
> • 两套安全远程访问方案
> • 各语言/工具连接示例与运维脚本

如有新增需求（高可用、读写分离、逻辑复制等）或遇到任何疑难，可在此基础上扩展或与我讨论！

---

## 10. 后续维护与优化建议

成功部署 PostgreSQL 后，为了确保其长期稳定高效运行，建议关注以下维护和优化点：

### 10.1 定期维护任务

-   **VACUUM**: 定期执行 `VACUUM`（尤其是 `VACUUM ANALYZE`）来回收已删除元组占用的空间，并更新统计信息，供查询优化器使用。对于频繁更新的表，自动清理 (Autovacuum) 通常能处理，但仍需监控其行为。
    ```sql
    -- 手动对特定表执行
    VACUUM (VERBOSE, ANALYZE) app_schema.users;
    ```
-   **索引维护**:
    -   监控索引膨胀和使用情况。未使用的索引会占用空间并拖慢写操作。
    -   定期 `REINDEX` 损坏的索引或重建碎片严重的索引。
    ```sql
    -- 重建特定索引
    REINDEX INDEX idx_users_name;
    -- 重建表的所有索引
    REINDEX TABLE app_schema.users;
    ```
-   **日志管理**: 监控 PostgreSQL 日志文件的大小，配置日志轮转，并定期归档旧日志。

### 10.2 性能监控与调优

-   **慢查询分析**: 启用 `log_min_duration_statement` (例如设置为 `200ms`) 来记录慢查询。使用 `EXPLAIN ANALYZE` 分析这些查询的执行计划，找出瓶颈并进行优化（如添加索引、改写查询）。
-   **连接池**: 对于应用层，使用连接池（如 PgBouncer 或应用内置连接池）来管理数据库连接，避免频繁创建和销毁连接带来的开销。
-   **参数调优**: 根据服务器资源和负载情况，调整 `postgresql.conf` 中的关键参数，如 `shared_buffers`, `work_mem`, `maintenance_work_mem`, `effective_cache_size`。使用 `pgtune` 等工具可以获取初步建议。
-   **监控工具**: 利用华为云的数据库监控服务，或部署 Prometheus + `postgres_exporter` + Grafana 等开源监控方案，实时监控数据库的各项指标（CPU、内存、磁盘I/O、连接数、事务速率、复制延迟等）。

### 10.3 安全加固

-   **定期更新**: 及时应用 PostgreSQL 和操作系统的安全补丁。
-   **最小权限原则**: 确保应用连接数据库的用户权限被限制在必需的最小范围。
-   **审计日志**: 根据需要配置 `pgaudit` 等扩展进行详细的数据库操作审计。
-   **网络安全**: 持续审查安全组规则，确保仅允许必要的IP地址或网段访问数据库端口。

### 10.4 备份与恢复策略验证

-   **定期测试恢复**: 不仅要执行备份，还要定期测试从备份中恢复数据的流程，确保备份的有效性和恢复流程的熟练度。
-   **PITR (Point-In-Time Recovery)**: 如果业务对数据丢失容忍度极低，应配置并测试基于WAL归档的时间点恢复。

通过持续的监控、维护和优化，可以确保您的 PostgreSQL 数据库在华为云上保持最佳性能和可靠性。
