# 📊 监控系统使用指南 - 从零到专家

## 🎯 首次使用必看

### 第一步：验证服务运行状态
```bash
# 检查所有监控服务是否运行
docker-compose ps

# 应该看到这些服务都是 "Up" 状态：
# - prometheus
# - grafana  
# - node-exporter
# - postgres-exporter
```

## 📈 Prometheus 使用指南

### 🚀 **Prometheus基础操作** (http://localhost:9090)

#### 1. 查看所有监控目标
- 点击顶部菜单 `Status` → `Targets`
- 你会看到所有被监控的服务：
  - `prometheus` - Prometheus自身
  - `node-exporter` - 系统指标
  - `postgres` - 数据库指标
  - `nestjs-server` - 你的后端API
  - `nextjs-blog` - 你的博客前端

#### 2. 简单查询示例
在主页的查询框输入以下查询：

**查看服务状态：**
```promql
up
```
> 结果：1表示服务正常，0表示服务下线

**查看CPU使用率：**
```promql
100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

**查看内存使用率：**
```promql
(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100
```

**查看HTTP请求速率：**
```promql
rate(http_requests_total[5m])
```

#### 3. 查看告警规则
- 点击 `Alerts` 查看告警状态
- 绿色表示正常，红色表示触发告警

## 🎨 Grafana 使用指南

### 🚀 **Grafana完整操作** (http://localhost:3003)

#### 第一步：登录
- 用户名：`admin`
- 密码：`admin123`

#### 第二步：验证数据源
1. 点击左侧菜单 ⚙️ `Configuration` → `Data Sources`
2. 应该看到 `Prometheus` 数据源，状态为绿色 ✅

#### 第三步：导入预设仪表盘
1. 点击左侧菜单 `+` → `Import`
2. 上传我们创建的仪表盘文件：`monitoring/grafana/dashboards/blog-system-overview.json`
3. 或者直接访问：http://localhost:3003/d/blog-system-overview

#### 第四步：理解仪表盘面板

**📊 仪表盘包含6个主要面板：**

1. **HTTP请求速率** - 显示每秒请求数
   - 绿线上升 = 访问量增加
   - 突然下降 = 可能有问题

2. **服务状态** - 显示各服务健康状况
   - 绿色数字 = 服务正常
   - 红色 = 服务下线

3. **HTTP响应时间** - 显示API响应速度
   - 蓝线 = 50%用户的响应时间
   - 橙线 = 95%用户的响应时间
   - 线条越低越好

4. **系统内存使用** - 显示服务器内存情况
   - 红线 = 已使用内存
   - 绿线 = 可用内存

5. **数据库连接** - 显示数据库连接数
   - 数字稳定 = 正常
   - 突然增加 = 可能有连接泄漏

6. **应用指标** - 显示业务数据
   - 用户总数
   - 文章总数

## 🔍 实用监控场景

### 场景1：检查系统是否正常
**步骤：**
1. 打开Grafana仪表盘
2. 查看 `服务状态` 面板，确保都是绿色
3. 查看 `HTTP请求速率`，确认有正常流量
4. 查看 `响应时间`，确认延迟正常(<500ms)

### 场景2：网站访问量分析
**步骤：**
1. 在 `HTTP请求速率` 面板查看流量趋势
2. 右上角调整时间范围（如：Last 24 hours）
3. 观察峰值时间段

### 场景3：性能问题排查
**当网站变慢时：**
1. 查看 `HTTP响应时间` - 是否延迟增加？
2. 查看 `系统内存使用` - 是否内存不足？
3. 查看 `数据库连接` - 是否连接数异常？

### 场景4：设置告警
**在Grafana中设置告警：**
1. 进入仪表盘编辑模式
2. 点击面板标题 → `Edit`
3. 切换到 `Alert` 标签
4. 设置告警条件（如：响应时间>1秒）

## 🛠️ 常用操作技巧

### Prometheus查询技巧
```promql
# 查看最近5分钟的平均值
avg_over_time(your_metric[5m])

# 查看增长率
rate(your_counter[5m])

# 按标签分组
sum by (status_code) (http_requests_total)

# 查看百分位数
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
```

### Grafana面板定制
1. **修改时间范围**：右上角时间选择器
2. **刷新频率**：右上角刷新按钮旁的下拉菜单
3. **全屏查看**：点击面板标题 → `View`
4. **导出数据**：点击面板标题 → `Inspect` → `Data`

## 🚨 告警理解指南

### 正常状态指标
- **CPU使用率**: <70%
- **内存使用率**: <80%
- **响应时间**: <500ms
- **错误率**: <1%
- **数据库连接**: 稳定不变

### 需要关注的异常
- **CPU突然飙升**: 可能有性能问题
- **内存持续增长**: 可能有内存泄漏
- **响应时间增加**: API性能下降
- **错误率上升**: 系统出现Bug
- **服务状态为0**: 服务下线

## 💡 实用监控建议

### 日常使用习惯
1. **每天早上**：查看仪表盘概览，确认系统状态
2. **部署后**：观察指标变化，确认新版本正常
3. **用户反馈慢**：立即查看响应时间和错误率
4. **定期回顾**：每周查看趋势，发现潜在问题

### 高级功能
1. **创建自定义仪表盘**：针对特定业务指标
2. **设置告警通知**：配置邮件/钉钉通知
3. **数据保留策略**：避免磁盘空间问题
4. **权限管理**：为团队成员分配不同权限

## 🎯 快速验证清单

### ✅ 验证监控是否工作正常
```bash
# 1. 检查应用指标端点
curl http://localhost:3001/api/metrics | head -10
curl http://localhost:3000/api/metrics | head -10

# 2. 访问你的博客，然后在Grafana查看是否有新的HTTP请求记录

# 3. 在Prometheus查询：up
# 应该看到所有target都是1

# 4. 在Grafana查看CPU/内存是否有数据显示
```

## 🆘 常见问题解决

### 问题1：Grafana显示"No data"
**解决方案：**
1. 检查数据源配置：http://prometheus:9090
2. 确认Prometheus正在收集数据
3. 检查查询语句是否正确

### 问题2：某些指标没有数据
**解决方案：**
1. 检查对应服务是否运行
2. 验证指标端点是否可访问
3. 查看Prometheus的Targets页面

### 问题3：响应时间异常高
**解决方案：**
1. 检查数据库连接数
2. 查看系统资源使用情况
3. 分析慢查询日志

---

## 🎉 恭喜！

现在你已经掌握了监控系统的基本使用！记住：
- 📊 **多看仪表盘**，培养数据敏感度
- 🔍 **遇到问题先查监控**，数据会告诉你答案
- 📈 **关注趋势而不是瞬时值**，避免误判

**开始你的监控之旅吧！** 🚀 