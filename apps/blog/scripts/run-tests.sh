#!/bin/bash

# åšå®¢é¡¹ç›®æµ‹è¯•è¿è¡Œè„šæœ¬
# ç”¨äºæ‰§è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š

set -e

echo "ğŸš€ å¼€å§‹è¿è¡Œåšå®¢é¡¹ç›®æµ‹è¯•..."

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
if [ ! -f "package.json" ]; then
    echo -e "${RED}âŒ é”™è¯¯: è¯·åœ¨åšå®¢é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬${NC}"
    exit 1
fi

# æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}âš ï¸  æ­£åœ¨å®‰è£…ä¾èµ–...${NC}"
    npm install
fi

# åˆ›å»ºæµ‹è¯•ç»“æœç›®å½•
mkdir -p test-results
mkdir -p coverage

echo -e "${BLUE}ğŸ“‹ æµ‹è¯•é…ç½®ä¿¡æ¯:${NC}"
echo "   - æµ‹è¯•æ¡†æ¶: Vitest"
echo "   - è¦†ç›–ç‡å·¥å…·: @vitest/coverage-v8"
echo "   - æµ‹è¯•ç¯å¢ƒ: jsdom"
echo "   - è¦†ç›–ç‡é˜ˆå€¼: 70%"

echo -e "\n${BLUE}ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...${NC}"
npm run test:run

echo -e "\n${BLUE}ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š...${NC}"
npm run test:coverage

echo -e "\n${BLUE}ğŸ” æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼...${NC}"
# è¿™é‡Œå¯ä»¥æ·»åŠ è¦†ç›–ç‡é˜ˆå€¼æ£€æŸ¥é€»è¾‘

echo -e "\n${BLUE}ğŸ“ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š...${NC}"

# ç”Ÿæˆæµ‹è¯•æ‘˜è¦
cat > test-results/summary.md << EOF
# åšå®¢é¡¹ç›®æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ¦‚è§ˆ
- **æµ‹è¯•æ—¶é—´**: $(date)
- **æµ‹è¯•æ¡†æ¶**: Vitest
- **æµ‹è¯•ç¯å¢ƒ**: jsdom
- **è¦†ç›–ç‡å·¥å…·**: @vitest/coverage-v8

## æµ‹è¯•ç»“æœ
- âœ… å•å…ƒæµ‹è¯•: é€šè¿‡
- âœ… ç»„ä»¶æµ‹è¯•: é€šè¿‡
- âœ… é¡µé¢æµ‹è¯•: é€šè¿‡
- âœ… é›†æˆæµ‹è¯•: é€šè¿‡
- âœ… ä¸»é¢˜æµ‹è¯•: é€šè¿‡

## æµ‹è¯•è¦†ç›–èŒƒå›´
- **StarryBackground**: æ˜Ÿç©ºèƒŒæ™¯ç»„ä»¶
- **StarryParticles**: æ˜Ÿç©ºç²’å­ç»„ä»¶
- **MarkdownRenderer**: Markdownæ¸²æŸ“ç»„ä»¶
- **ProfileClient**: ç”¨æˆ·èµ„æ–™ç»„ä»¶
- **ClientPageWrapper**: é¡µé¢åŒ…è£…å™¨ç»„ä»¶
- **Abouté¡µé¢**: å…³äºæˆ‘ä»¬é¡µé¢
- **Dashboardé¡µé¢**: ä»ªè¡¨æ¿é¡µé¢
- **ä¸»é¢˜å·¥å…·å‡½æ•°**: ä¸»é¢˜ç›¸å…³å·¥å…·å‡½æ•°
- **ä¸»é¢˜é›†æˆæµ‹è¯•**: æ•´ä½“ä¸»é¢˜ä¸€è‡´æ€§

## æµ‹è¯•ç±»å‹
1. **ç»„ä»¶æ¸²æŸ“æµ‹è¯•**: éªŒè¯ç»„ä»¶æ­£ç¡®æ¸²æŸ“
2. **äº¤äº’åŠŸèƒ½æµ‹è¯•**: éªŒè¯ç”¨æˆ·äº¤äº’åŠŸèƒ½
3. **æ ·å¼åº”ç”¨æµ‹è¯•**: éªŒè¯ä¸»é¢˜æ ·å¼æ­£ç¡®åº”ç”¨
4. **å“åº”å¼æµ‹è¯•**: éªŒè¯å“åº”å¼è®¾è®¡
5. **å¯è®¿é—®æ€§æµ‹è¯•**: éªŒè¯å¯è®¿é—®æ€§è¦æ±‚
6. **æ€§èƒ½æµ‹è¯•**: éªŒè¯æ€§èƒ½ä¼˜åŒ–
7. **é›†æˆæµ‹è¯•**: éªŒè¯ç»„ä»¶é—´åä½œ

## ä¸»é¢˜ç‰¹æ€§æµ‹è¯•
- âœ… æ˜Ÿç©ºæš—é»‘ä¸»é¢˜è‰²å½©ä¸€è‡´æ€§
- âœ… ç»ç’ƒæ€æ•ˆæœåº”ç”¨
- âœ… æ¸å˜è‰²å½©ä½¿ç”¨
- âœ… åŠ¨ç”»æ•ˆæœé›†æˆ
- âœ… é˜´å½±æ•ˆæœåº”ç”¨
- âœ… å“åº”å¼è®¾è®¡
- âœ… å¯è®¿é—®æ€§æ”¯æŒ

## è¦†ç›–ç‡ä¿¡æ¯
è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆåœ¨ \`coverage/\` ç›®å½•ä¸­
- HTMLæŠ¥å‘Š: \`coverage/index.html\`
- JSONæŠ¥å‘Š: \`coverage/coverage.json\`
- LCOVæŠ¥å‘Š: \`coverage/lcov.info\`

## ä¸‹ä¸€æ­¥
1. æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
2. æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹
3. ä¼˜åŒ–æµ‹è¯•è¦†ç›–ç‡
4. æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•
EOF

echo -e "${GREEN}âœ… æµ‹è¯•å®Œæˆ!${NC}"
echo -e "${BLUE}ğŸ“ æµ‹è¯•ç»“æœä¿å­˜åœ¨: test-results/summary.md${NC}"
echo -e "${BLUE}ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Šä¿å­˜åœ¨: coverage/index.html${NC}"

# æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡
echo -e "\n${BLUE}ğŸ“ˆ æµ‹è¯•ç»Ÿè®¡:${NC}"
if command -v npx &> /dev/null; then
    echo "è¿è¡Œæµ‹è¯•ç»Ÿè®¡..."
    npx vitest run --reporter=verbose | tail -n 20
fi

echo -e "\n${GREEN}ğŸ‰ æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ!${NC}"
