name: æµ‹è¯•å’Œè¦†ç›–ç‡æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œæµ‹è¯•
      run: npm run test:coverage
      
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        
    - name: æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
      run: |
        # æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
        if [ -f "coverage/coverage-summary.json" ]; then
          COVERAGE=$(node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            console.log(Math.round(total.lines.pct));
          ")
          
          if [ $COVERAGE -lt 70 ]; then
            echo "âŒ è¦†ç›–ç‡ä½äº70%: $COVERAGE%"
            exit 1
          else
            echo "âœ… è¦†ç›–ç‡è¾¾æ ‡: $COVERAGE%"
          fi
        fi
        
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      if: always()
      run: |
        # ç”Ÿæˆæµ‹è¯•æ‘˜è¦
        echo "# æµ‹è¯•æŠ¥å‘Š" > test-report.md
        echo "" >> test-report.md
        echo "## æ‰§è¡Œæ—¶é—´" >> test-report.md
        echo "- å¼€å§‹æ—¶é—´: ${{ github.event.head_commit.timestamp }}" >> test-report.md
        echo "- ç»“æŸæ—¶é—´: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> test-report.md
        echo "" >> test-report.md
        echo "## è¦†ç›–ç‡" >> test-report.md
        if [ -f "coverage/coverage-summary.json" ]; then
          node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            console.log('- è¯­å¥è¦†ç›–ç‡:', total.statements.pct + '%');
            console.log('- åˆ†æ”¯è¦†ç›–ç‡:', total.branches.pct + '%');
            console.log('- å‡½æ•°è¦†ç›–ç‡:', total.functions.pct + '%');
            console.log('- è¡Œè¦†ç›–ç‡:', total.lines.pct + '%');
          " >> test-report.md
        fi
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: |
          test-report.md
          coverage/
          test-results/
          
  performance:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: npm run test:performance
      
    - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: test-results/performance-report.json
        
  quality-gate:
    runs-on: ubuntu-latest
    needs: [test, performance]
    
    steps:
    - name: ä¸‹è½½æµ‹è¯•æŠ¥å‘Š
      uses: actions/download-artifact@v3
      with:
        name: test-report
        
    - name: ä¸‹è½½æ€§èƒ½æŠ¥å‘Š
      uses: actions/download-artifact@v3
      with:
        name: performance-report
        
    - name: è´¨é‡é—¨ç¦æ£€æŸ¥
      run: |
        echo "ğŸ” æ‰§è¡Œè´¨é‡é—¨ç¦æ£€æŸ¥..."
        
        # æ£€æŸ¥æµ‹è¯•æ˜¯å¦é€šè¿‡
        if [ "${{ needs.test.result }}" != "success" ]; then
          echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œè´¨é‡é—¨ç¦æœªé€šè¿‡"
          exit 1
        fi
        
        # æ£€æŸ¥è¦†ç›–ç‡
        if [ -f "coverage/coverage-summary.json" ]; then
          COVERAGE=$(node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            console.log(Math.round(total.lines.pct));
          ")
          
          if [ $COVERAGE -lt 70 ]; then
            echo "âŒ è¦†ç›–ç‡ä½äº70%: $COVERAGE%ï¼Œè´¨é‡é—¨ç¦æœªé€šè¿‡"
            exit 1
          fi
        fi
        
        # æ£€æŸ¥æ€§èƒ½
        if [ -f "test-results/performance-report.json" ]; then
          SLOW_TESTS=$(node -e "
            const fs = require('fs');
            const perf = JSON.parse(fs.readFileSync('test-results/performance-report.json', 'utf8'));
            const slowTests = perf.performanceDistribution?.slow || 0;
            console.log(slowTests);
          ")
          
          if [ $SLOW_TESTS -gt 10 ]; then
            echo "âŒ æ…¢é€Ÿæµ‹è¯•è¿‡å¤š: $SLOW_TESTSï¼Œè´¨é‡é—¨ç¦æœªé€šè¿‡"
            exit 1
          fi
        fi
        
        echo "âœ… è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡"
        
    - name: å‘é€é€šçŸ¥
      if: always()
      run: |
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.performance.result }}" == "success" ]; then
          echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
        else
          echo "âš ï¸ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
        fi
